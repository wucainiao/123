# 数据库初始化与种子脚本
# 用法: python scripts/init_db.py

import os
import sys
# Ensure project root is on sys.path so local modules (app, models) are imported
sys.path.insert(0, os.path.abspath(os.path.join(os.path.dirname(__file__), '..')))

from app import db, app
from models import Realm, Meridian, Acupoint

# 简化：根据设计文档为境界和经脉/穴位做基础种子
REALMS = [
    ("凡人期", 1, 0.0),
    ("炼气期", 2, 0.5),
    ("筑基期", 3, 1.2),
    ("金丹期", 4, 2.5),
    ("元婴期", 5, 4.0),
    ("化神期", 6, 7.0),
    ("炼虚期", 7, 10.0),
    ("合体期", 8, 14.0),
    ("大乘期", 9, 19.0),
    ("渡劫期", 10, 25.0),
    ("人仙", 11, 32.0),
    ("地仙", 11, 40.0),
    ("天仙", 11, 49.0),
    ("真仙", 11, 59.0),
    ("玄仙", 11, 70.0),
    ("金仙", 12, 82.0),
    ("太乙金仙", 12, 95.0),
    ("大罗金仙", 12, 109.0),
    ("混元金仙", 13, 124.0),
    ("混元大罗金仙", 13, 140.0),
    ("天道境", 14, 160.0),
    ("大道境", 14, 200.0)
]

MERIDIANS = {
    "手太阴肺经": [
        "中府","云门","天府","侠白","尺泽","孔最","列缺","经渠","太渊","鱼际","少商"
    ],
    "手阳明大肠经": [
        "商阳","二间","三间","合谷","阳溪","偏历","温溜","下廉","上廉","手三里",
        "曲池","肘髎","手五里","臂臑","肩髃","巨骨","天鼎","扶突","口禾髎","迎香"
    ],
    "足阳明胃经": [
        "承泣","四白","巨髎","地仓","大迎","颊车","下关","头维","人迎","水突","气舍","缺盆",
        "气户","库房","屋翳","膺窗","乳中","乳根","不容","承满","梁门","关门","太乙","滑肉门",
        "天枢","外陵","大巨","水道","归来","气冲","髀关","伏兔","阴市","梁丘","犊鼻","足三里",
        "上巨虚","条口","下巨虚","丰隆","解溪","冲阳","陷谷","内庭","厉兑"
    ],
    "足太阴脾经": [
        "隐白","大都","太白","公孙","商丘","三阴交","漏谷","地机","阴陵泉","血海","箕门",
        "冲门","府舍","腹结","大横","腹哀","食窦","天溪","胸乡","周荣","大包"
    ],
    "手少阴心经": [
        "极泉","青灵","少海","灵道","通里","阴郄","神门","少府","少冲"
    ],
    "手太阳小肠经": [
        "少泽","前谷","后溪","腕骨","阳谷","养老","支正","小海","肩贞","臑俞","天宗","秉风",
        "曲垣","肩外俞","肩中俞","天窗","天容","颧髎","听宫"
    ],
    "足太阳膀胱经": [
        "睛明","攒竹","眉冲","曲差","五处","承光","通天","络却","玉枕","天柱","大杼","风门",
        "肺俞","厥阴俞","心俞","督俞","膈俞","肝俞","胆俞","脾俞","胃俞","三焦俞","肾俞","气海俞",
        "大肠俞","关元俞","小肠俞","膀胱俞","中脂俞","白环俞","上髎","次髎","中髎","下髎","会阳",
        "承扶","殷门","浮郄","委阳","委中","附分","魄户","膏肓俞","神堂","譩譆","膈关","魂门",
        "阳纲","意舍","胃仓","肓门","志室","胞肓","秩边","合阳","承筋","承山","飞扬","跗阳",
        "昆仑","仆参","申脉","金门","京骨","束骨","足通谷","至阴"
    ],
    "足少阴肾经": [
        "涌泉","然谷","太溪","大钟","水泉","照海","复溜","交信","筑宾","阴谷","横骨","大赫",
        "气穴","四满","中注","肓俞","商曲","石关","阴都","腹通谷","幽门","步廊","神封","灵墟",
        "神藏","彧中","俞府"
    ],
    "手厥阴心包经": [
        "天池","天泉","曲泽","郄门","间使","内关","大陵","劳宫","中冲"
    ],
    "手少阳三焦经": [
        "关冲","液门","中渚","阳池","外关","支沟","会宗","三阳络","四渎","天井","清冷渊","消泺",
        "臑会","肩髎","天髎","天牖","翳风","瘛脉","颅息","角孙","耳门","耳和髎","丝竹空"
    ],
    "足少阳胆经": [
        "瞳子髎","听会","上关","颔厌","悬颅","悬厘","曲鬓","率谷","天冲","浮白","头窍阴","完骨",
        "本神","阳白","头临泣","目窗","正营","承灵","脑空","风池","肩井","渊腋","辄筋","日月",
        "京门","带脉","五枢","维道","居髎","环跳","风市","中渎","膝阳关","阳陵泉","阳交","外丘",
        "光明","阳辅","悬钟","丘墟","足临泣","地五会","侠溪","足窍阴"
    ],
    "足厥阴肝经": [
        "大敦","行间","太冲","中封","蠡沟","中都","膝关","曲泉","阴包","足五里","阴廉","急脉",
        "章门","期门"
    ],
    "任脉": [
        "会阴","曲骨","中极","关元","石门","气海","阴交","神阙","水分","下脘","建里","中脘",
        "上脘","巨阙","鸠尾","中庭","膻中","玉堂","紫宫","华盖","璇玑","天突","廉泉","承浆"
    ],
    "督脉": [
        "长强","腰俞","腰阳关","命门","悬枢","脊中","中枢","筋缩","至阳","灵台","神道","身柱",
        "陶道","大椎","哑门","风府","脑户","强间","后顶","百会","前顶","囟会","上星","神庭",
        "素髎","水沟","兑端","龈交"
    ]
}


def seed():
    import traceback
    with app.app_context():
        print('init_db: entering app context')
        try:
            # 测试数据库连接
            print('init_db: testing DB engine connection, SQLALCHEMY_DATABASE_URI=', app.config.get('SQLALCHEMY_DATABASE_URI'))
            from sqlalchemy import text
            db.session.execute(text('SELECT 1'))
        except Exception as e:
            print('Database connection test failed:', str(e))
            traceback.print_exc()
            raise
        try:
            # 创建缺失的表（不删除现有表以保留数据）
            db.create_all()
            # 不对已存在表执行 DROP/CREATE 操作，避免破坏已有数据或迁移状态。
            # 如果需要更改表结构，请在迁移脚本或 Alembic 中处理。

            # 境界
            for name, stage, coeff in REALMS:
                if not Realm.query.filter_by(name=name).first():
                    r = Realm(name=name, stage=stage, coefficient=coeff)
                    db.session.add(r)
            db.session.commit()

            # 经脉与穴位（按设计文档的具体穴位名创建）
            for mname, points in MERIDIANS.items():
                if not Meridian.query.filter_by(name=mname).first():
                    mer = Meridian(name=mname, coefficient=(2.5 if mname in ('任脉', '督脉') else 1.5))
                    db.session.add(mer)
                    db.session.commit()
                    for pname in points:
                        ap = Acupoint(meridian_id=mer.id, name=pname, level=0, max_level=10, attribute_bonus=0)
                        db.session.add(ap)
            db.session.commit()
            print('Database initialized and seed data created.')
        except Exception as e:
            print('Seeding failed:', str(e))
            traceback.print_exc()
            raise

if __name__ == '__main__':
    seed()
