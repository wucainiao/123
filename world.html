<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>世界地图 - 修仙游戏</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="static/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .world-map {
            background: linear-gradient(135deg, #74c69d 0%, #f9ca24 100%);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 500px;
            position: relative;
            overflow: hidden;
        }
        .map-point {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            color: white;
            font-weight: bold;
            text-align: center;
            font-size: 12px;
        }
        .map-point:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        .map-point.village {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .map-point.forest {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .map-point.mountain {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        .map-point.wasteland {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }
        .map-point.ruins {
            background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%);
        }
        .exploration-log {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .resource-display {
            background: rgba(255,255,255,0.9);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .point-info {
            background: rgba(255,255,255,0.95);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark shadow-soft" style="background:linear-gradient(90deg, rgba(11,18,32,0.9), rgba(7,26,47,0.9));">
        <div class="container">
            <a class="navbar-brand" href="index.html">修仙世界</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="mainNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">主页</a></li>
                    <li class="nav-item"><a class="nav-link" href="home.html">游戏</a></li>
                    <li class="nav-item"><a class="nav-link" href="world.html">世界</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="app-wrap container mt-4">
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h4>世界地图</h4>
                    </div>
                    <div class="card-body">
                        <div class="world-map" id="world-map">
                            <!-- 地图点将在这里动态生成 -->
                        </div>
                    </div>
                </div>

                <div class="point-info" id="point-info" style="display: none;">
                    <h5 id="point-name">地点名称</h5>
                    <p id="point-description">地点描述</p>
                    <div class="mb-3">
                        <strong>可采集资源:</strong>
                        <div id="point-resources" class="mt-2">
                            <!-- 资源列表将在这里显示 -->
                        </div>
                    </div>
                    <button class="btn btn-primary" id="explore-btn" onclick="exploreCurrentPoint()">
                        开始探索
                    </button>
                </div>
            </div>

            <div class="col-md-4">
                <div class="resource-display">
                    <h5>当前资源</h5>
                    <div id="resource-list">
                        <!-- 资源将在这里显示 -->
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h5>探索日志</h5>
                    </div>
                    <div class="card-body">
                        <div class="exploration-log" id="exploration-log">
                            <!-- 探索日志将在这里显示 -->
                        </div>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        <h5>奇遇事件</h5>
                    </div>
                    <div class="card-body">
                        <div id="random-events">
                            <!-- 随机事件将在这里显示 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- 探索结果模态框 -->
    <div class="modal fade" id="explorationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">探索结果</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="exploration-result">
                        <!-- 探索结果将在这里显示 -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">确定</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentMapPoints = [];
        let currentPointId = null;

        // 获取认证令牌
        function getToken() {
            return localStorage.getItem('token');
        }

        // API调用函数
        async function apiCall(endpoint, options = {}) {
            const token = getToken();
            if (!token) {
                alert('请先登录');
                return null;
            }

            const defaultOptions = {
                headers: {
                    'Authorization': token,
                    'Content-Type': 'application/json'
                }
            };

            const response = await fetch(endpoint, { ...defaultOptions, ...options });
            if (response.status === 401) {
                alert('认证失败，请重新登录');
                return null;
            }
            return response.json();
        }

        // 加载世界地图
        async function loadWorldMap() {
            const mapData = await apiCall('/world/map');
            if (mapData) {
                currentMapPoints = mapData.map_points;
                renderMapPoints();
                loadResources();
            }
        }

        // 渲染地图点
        function renderMapPoints() {
            const mapContainer = document.getElementById('world-map');
            mapContainer.innerHTML = '';

            currentMapPoints.forEach(point => {
                const pointElement = document.createElement('div');
                pointElement.className = `map-point ${point.type}`;
                pointElement.style.left = `${point.x + 50}%`;
                pointElement.style.top = `${point.y + 50}%`;
                pointElement.title = point.name;
                pointElement.innerHTML = `
                    <div>${point.name}</div>
                    <small>${point.weather}</small>
                `;
                pointElement.onclick = () => selectMapPoint(point);
                mapContainer.appendChild(pointElement);
            });
        }

        // 选择地图点
        function selectMapPoint(point) {
            currentPointId = point.id;

            document.getElementById('point-name').textContent = point.name;
            document.getElementById('point-description').textContent = `${point.type}地区，天气：${point.weather}`;

            const resourcesDiv = document.getElementById('point-resources');
            resourcesDiv.innerHTML = '';
            point.resources.forEach(resource => {
                const resourceItem = document.createElement('span');
                resourceItem.className = 'badge bg-secondary me-1';
                resourceItem.textContent = resource;
                resourcesDiv.appendChild(resourceItem);
            });

            document.getElementById('point-info').style.display = 'block';
        }

        // 探索当前选中的地点
        async function exploreCurrentPoint() {
            if (!currentPointId) {
                alert('请先选择一个地点');
                return;
            }

            const result = await apiCall(`/world/explore/${currentPointId}`, {
                method: 'POST'
            });

            if (result) {
                showExplorationResult(result);
                loadResources(); // 重新加载资源
                addExplorationLog(result);
            }
        }

        // 显示探索结果
        function showExplorationResult(result) {
            const resultDiv = document.getElementById('exploration-result');
            resultDiv.innerHTML = '';

            // 显示事件
            if (result.events && result.events.length > 0) {
                resultDiv.innerHTML += '<h6>探索事件：</h6><ul>';
                result.events.forEach(event => {
                    resultDiv.innerHTML += `<li>${event}</li>`;
                });
                resultDiv.innerHTML += '</ul>';
            }

            // 显示获得的资源
            if (result.resources_gained && result.resources_gained.length > 0) {
                resultDiv.innerHTML += '<h6>获得资源：</h6><ul>';
                result.resources_gained.forEach(resource => {
                    resultDiv.innerHTML += `<li>${resource.type}: ${resource.amount}</li>`;
                });
                resultDiv.innerHTML += '</ul>';
            }

            const modal = new bootstrap.Modal(document.getElementById('explorationModal'));
            modal.show();
        }

        // 添加探索日志
        function addExplorationLog(result) {
            const logContainer = document.getElementById('exploration-log');
            const logEntry = document.createElement('div');
            logEntry.className = 'mb-2 p-2 border-bottom';

            let logContent = `<strong>探索完成</strong><br>`;
            if (result.events && result.events.length > 0) {
                logContent += `事件: ${result.events.join(', ')}<br>`;
            }
            if (result.resources_gained && result.resources_gained.length > 0) {
                const resourceText = result.resources_gained.map(r => `${r.type}+${r.amount}`).join(', ');
                logContent += `获得: ${resourceText}`;
            }

            logEntry.innerHTML = logContent;
            logContainer.insertBefore(logEntry, logContainer.firstChild);

            // 限制日志数量
            while (logContainer.children.length > 10) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }

        // 加载资源显示
        async function loadResources() {
            // 这里应该调用一个获取资源的API，但暂时模拟
            const resourceData = [
                { type: '灵石', amount: 1000 },
                { type: '木材', amount: 50 },
                { type: '矿石', amount: 30 },
                { type: '灵植种子', amount: 5 }
            ];

            const resourceList = document.getElementById('resource-list');
            resourceList.innerHTML = '';

            resourceData.forEach(resource => {
                const resourceItem = document.createElement('div');
                resourceItem.className = 'd-flex justify-content-between align-items-center mb-2';
                resourceItem.innerHTML = `
                    <span>${resource.type}</span>
                    <span class="badge bg-primary">${resource.amount}</span>
                `;
                resourceList.appendChild(resourceItem);
            });
        }

        // 生成随机事件
        function generateRandomEvent() {
            const events = [
                '你在探索中发现了一个神秘的洞穴！',
                '一只灵兽从你身边跑过！',
                '你听到远处传来阵阵仙音...',
                '前方出现了一个古老的石碑。',
                '一股灵气从地下涌出！'
            ];

            const randomEvent = events[Math.floor(Math.random() * events.length)];
            const eventDiv = document.createElement('div');
            eventDiv.className = 'alert alert-info mb-2';
            eventDiv.innerHTML = `<small>${new Date().toLocaleTimeString()}: ${randomEvent}</small>`;

            const eventsContainer = document.getElementById('random-events');
            eventsContainer.insertBefore(eventDiv, eventsContainer.firstChild);

            // 限制事件数量
            while (eventsContainer.children.length > 5) {
                eventsContainer.removeChild(eventsContainer.lastChild);
            }

            // 5秒后自动移除事件
            setTimeout(() => {
                if (eventDiv.parentNode) {
                    eventDiv.remove();
                }
            }, 5000);
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadWorldMap();

            // 每30秒生成一个随机事件
            setInterval(generateRandomEvent, 30000);
        });
    </script>
</body>
</html>
